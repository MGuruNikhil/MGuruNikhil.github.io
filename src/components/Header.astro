---
import IconSprite from './IconSprite.astro'
---

<header class="border-b card-border">
  <IconSprite />
  <div class="container mx-auto px-4 py-4 flex items-center justify-between">
    <a href="/" class="flex items-center gap-3">
      <img src="https://github.com/MGuruNikhil.png" alt="avatar" class="w-10 h-10 rounded-full" />
      <span class="font-semibold">Guru Nikhil Mangaraju</span>
    </a>

    <nav class="hidden md:flex items-center gap-6 text-sm">
      <a href="/about" class="link-underline">About</a>
      <a href="/projects" class="link-underline">Projects</a>
      <a href="/work" class="link-underline">Work</a>
      <a href="/resume" class="link-underline">Resume</a>
      <a href="/contact" class="link-underline">Contact</a>
    </nav>

    <div class="flex items-center gap-3">
      <!-- Mobile menu toggle (visible on small screens) -->
      <button id="mobile-menu-toggle" class="md:hidden icon-link" aria-label="Toggle menu" aria-expanded="false" aria-controls="mobile-menu" type="button">
        <svg id="mobile-menu-icon" class="icon"><use href="#icon-menu" /></svg>
      </button>

      <button id="theme-toggle" class="icon-link" aria-label="Toggle theme" aria-pressed="false" type="button">
        <svg id="theme-icon" class="icon"><use href="#icon-sun" /></svg>
      </button>

      <a class="icon-link hidden md:inline-flex" href="https://github.com/MGuruNikhil" target="_blank" rel="noreferrer" aria-label="GitHub">
        <svg class="icon"><use href="#icon-github" /></svg>
      </a>
      <a class="icon-link hidden md:inline-flex" href="https://www.linkedin.com/in/gurunikhilm/" target="_blank" rel="noreferrer" aria-label="LinkedIn">
        <svg class="icon"><use href="#icon-linkedin" /></svg>
      </a>
    </div>
  </div>
</div>

  <!-- Mobile navigation (hidden by default, shown when toggled) -->
  <nav id="mobile-menu" class="md:hidden hidden px-4 pb-4">
    <div class="flex flex-col gap-3 text-sm">
      <a href="/about" class="link-underline">About</a>
      <a href="/projects" class="link-underline">Projects</a>
      <a href="/work" class="link-underline">Work</a>
      <a href="/resume" class="link-underline">Resume</a>
      <a href="/contact" class="link-underline">Contact</a>
    </div>
  </nav>

</header>

<script is:inline>
  (function () {
    try {
      var btn = document.getElementById('theme-toggle')
      var icon = document.getElementById('theme-icon')
      if (!btn || !icon) return

      function updateIcon(theme) {
        var use = icon.querySelector('use')
        if (!use) return
        use.setAttribute('href', theme === 'dark' ? '#icon-moon' : '#icon-sun')
        btn.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false')
      }

      // Initialize based on pre-run theme (ThemeScript sets this synchronously)
      var current = window.getTheme ? window.getTheme() : (document.documentElement.classList.contains('dark') ? 'dark' : 'light')
      updateIcon(current)

      // Listen for click -> call toggleTheme exposed by ThemeScript
      btn.addEventListener('click', function () {
        if (window.toggleTheme) {
          var isDark = window.toggleTheme()
          updateIcon(isDark ? 'dark' : 'light')
        }
      })

      // Also listen for programmatic theme changes
      window.addEventListener('themechange', function (e) { updateIcon(e.detail && e.detail.theme) })
    } catch (e) { console.warn('Theme toggle init failed', e) }
  })()
</script>

<script is:inline>
  (function () {
    try {
      var mobileBtn = document.getElementById('mobile-menu-toggle')
      var mobileIcon = document.getElementById('mobile-menu-icon')
      var mobileMenu = document.getElementById('mobile-menu')
      if (!mobileBtn || !mobileIcon || !mobileMenu) return

      function setOpen(open) {
        mobileBtn.setAttribute('aria-expanded', open ? 'true' : 'false')
        if (open) {
          mobileMenu.classList.remove('hidden')
          mobileIcon.querySelector('use').setAttribute('href', '#icon-close')
        } else {
          mobileMenu.classList.add('hidden')
          mobileIcon.querySelector('use').setAttribute('href', '#icon-menu')
        }
      }

      // Toggle on click
      mobileBtn.addEventListener('click', function () { setOpen(mobileBtn.getAttribute('aria-expanded') !== 'true') })

      // Close on escape
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' || e.key === 'Esc') setOpen(false)
      })

      // Close when a nav link is activated (good for single-page/hard navigation)
      mobileMenu.addEventListener('click', function (e) {
        var a = e.target.closest && e.target.closest('a')
        if (a) setOpen(false)
      })

      // Keep initial state consistent with markup
      setOpen(false)

      // Ensure the mobile menu closes automatically when viewport becomes large
      // (match Tailwind's `md` breakpoint at 768px). This prevents the mobile
      // menu from remaining visible after a user opens it and then resizes the
      // window to a larger width.
      var mq = window.matchMedia && window.matchMedia('(min-width: 768px)')
      if (mq) {
        var mqHandler = function (ev) { if (ev.matches) setOpen(false) }
        if (mq.addEventListener) mq.addEventListener('change', mqHandler)
        else if (mq.addListener) mq.addListener(mqHandler)
      }
    } catch (err) { console.warn('Mobile menu init failed', err) }
  })()
</script>
